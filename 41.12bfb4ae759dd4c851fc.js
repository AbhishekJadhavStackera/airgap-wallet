(window.webpackJsonp=window.webpackJsonp||[]).push([[41],{"1ZIO":function(t,e,o){"use strict";o.r(e),o.d(e,"TransactionConfirmPageModule",function(){return P});var i=o("ofXK"),n=o("3Pt+"),a=o("tyNb"),c=o("TEn/"),s=o("sYmb"),r=o("j1ZV"),l=o("mrSG"),b=o("138U"),d=o("RKiA"),h=o("14cC"),p=o("kB5k"),u=o.n(p),g=o("57MG"),f=o("jysE"),T=o("1y+R"),S=o("q3zY"),O=o("GsAe"),m=o("hPkG"),y=o("AFs5"),v=o("8xAc"),I=o("fXoL");const A=function(t){return{protocol:t,maxDigits:void 0}},N=function(t){return{protocol:t}};function w(t,e){if(1&t&&(I.Qb(0),I.Sb(1,"ion-row",1),I.Sb(2,"ion-col",2),I.Sb(3,"h5"),I.yc(4),I.dc(5,"async"),I.dc(6,"amountConverter"),I.Rb(),I.Rb(),I.Sb(7,"ion-col",2),I.Sb(8,"h5"),I.yc(9),I.Rb(),I.Rb(),I.Sb(10,"ion-col",2),I.Sb(11,"h5"),I.yc(12),I.dc(13,"async"),I.dc(14,"feeConverter"),I.Rb(),I.Rb(),I.Sb(15,"ion-col",3),I.Sb(16,"small"),I.yc(17,"Amount"),I.Rb(),I.Rb(),I.Sb(18,"ion-col",3),I.Sb(19,"small"),I.yc(20,"Operations"),I.Rb(),I.Rb(),I.Sb(21,"ion-col",3),I.Sb(22,"small"),I.yc(23,"Fee"),I.Rb(),I.Rb(),I.Rb(),I.Pb()),2&t){const t=I.cc();I.Cb(4),I.Ac(" ",I.ec(5,3,I.fc(6,5,t.aggregatedInfo.totalAmount.toFixed(),I.mc(13,A,t.airGapTxs[0].protocolIdentifier)))," "),I.Cb(5),I.zc(t.aggregatedInfo.numberOfTxs),I.Cb(3),I.zc(I.ec(13,8,I.fc(14,10,t.aggregatedInfo.totalFees.toFixed(),I.mc(15,N,t.airGapTxs[0].protocolIdentifier))))}}function x(t,e){1&t&&I.Ob(0,"airgap-from-to",5),2&t&&I.ic("transaction",e.$implicit)}function j(t,e){if(1&t&&(I.Qb(0),I.wc(1,x,1,1,"airgap-from-to",4),I.Pb()),2&t){const t=I.cc();I.Cb(1),I.ic("ngForOf",t.airGapTxs)}}function C(t,e){if(1&t&&(I.Sb(0,"span"),I.Sb(1,"ion-row"),I.Sb(2,"ion-col",6),I.Ob(3,"ion-icon",7),I.Rb(),I.Sb(4,"ion-col"),I.yc(5),I.dc(6,"translate"),I.Rb(),I.Rb(),I.Sb(7,"p",8),I.yc(8),I.Rb(),I.Rb()),2&t){const t=I.cc();I.Cb(5),I.Ac(" ",I.ec(6,2,"signed-transaction.transaction-unreadable")," "),I.Cb(3),I.Ac(" ",t.rawTxData.transaction," ")}}let R=(()=>{class t{constructor(t,e,o){this.serializerService=t,this.protocolService=e,this.accountProvider=o,this.fallbackActivated=!1}ngOnChanges(){return Object(l.a)(this,void 0,void 0,function*(){if(this.syncProtocolString)try{this.signedTxs=yield this.serializerService.deserialize(this.syncProtocolString)[0]}catch(t){this.fallbackActivated=!0,Object(m.b)(m.a.COINLIB)(t)}if(this.signedTxs){let e=this.protocols&&this.protocols[0]?this.protocols[0]:yield this.protocolService.getProtocol(this.signedTxs[0].protocol);try{this.airGapTxs=(yield Promise.all(this.signedTxs.map(t=>Object(l.a)(this,void 0,void 0,function*(){const o=t.payload;return(yield this.checkIfSaplingTransaction(o,t.protocol))?(yield this.getSaplingProtocol()).getTransactionDetailsFromSigned(o,{knownViewingKeys:this.accountProvider.getKnownViewingKeys()}):e.getTransactionDetailsFromSigned(o)})))).reduce((t,e)=>t.concat(e),[]),this.airGapTxs.length>1&&this.airGapTxs.every(t=>t.protocolIdentifier===this.airGapTxs[0].protocolIdentifier)&&(this.aggregatedInfo={numberOfTxs:this.airGapTxs.length,totalAmount:this.airGapTxs.map(t=>new u.a(t.amount)).filter(t=>!t.isNaN()).reduce((t,e)=>t.plus(e),new u.a(0)),totalFees:this.airGapTxs.reduce((t,e)=>t.plus(e.fee),new u.a(0))}),this.fallbackActivated=!1}catch(t){console.error(t),this.fallbackActivated=!0,this.rawTxData=this.signedTxs[0].payload,Object(m.b)(m.a.COINLIB)(t)}}})}checkIfSaplingTransaction(t,e){return Object(l.a)(this,void 0,void 0,function*(){if(e===d.MainProtocolSymbols.XTZ){const o=yield this.protocolService.getProtocol(e),i=yield this.getSaplingProtocol();return(yield o.getTransactionDetailsFromSigned(t)).map(t=>t.to).reduce((t,e)=>t.concat(e),[]).includes(i.options.config.contractAddress)}return e===d.MainProtocolSymbols.XTZ_SHIELDED})}getSaplingProtocol(){return Object(l.a)(this,void 0,void 0,function*(){return yield this.protocolService.getProtocol(d.MainProtocolSymbols.XTZ_SHIELDED)})}}return t.\u0275fac=function(e){return new(e||t)(I.Nb(b.D),I.Nb(b.x),I.Nb(g.a))},t.\u0275cmp=I.Hb({type:t,selectors:[["signed-transaction"]],inputs:{signedTxs:"signedTxs",protocols:"protocols",syncProtocolString:"syncProtocolString"},features:[I.Ab],decls:4,vars:3,consts:[[4,"ngIf"],[1,"ion-padding-bottom","ion-text-center"],["size","4",1,"content--align__center-center"],["size","4"],[3,"transaction",4,"ngFor","ngForOf"],[3,"transaction"],["size","2",1,"ion-margin-top"],["color","dark","name","warning",1,"warning-icon"],["ion-text","","color","blackLight",1,"text--selectable","typography--mono"]],template:function(t,e){1&t&&(I.Sb(0,"span"),I.wc(1,w,24,17,"ng-container",0),I.wc(2,j,2,1,"ng-container",0),I.wc(3,C,9,4,"span",0),I.Rb()),2&t&&(I.Cb(1),I.ic("ngIf",e.airGapTxs&&e.airGapTxs.length>1),I.Cb(1),I.ic("ngIf",e.airGapTxs),I.Cb(1),I.ic("ngIf",e.fallbackActivated))},directives:[i.o,c.Q,c.p,i.n,b.o,c.w],pipes:[i.b,b.g,b.n,s.c],styles:[".warning-icon[_ngcontent-%COMP%]{font-size:4rem}"]}),t})(),k=(()=>{class t{constructor(t,e,o,i,n,a,c,s,r,l,b,d,h,p){this.loadingCtrl=t,this.toastCtrl=e,this.router=o,this.route=i,this.alertCtrl=n,this.platform=a,this.storageProvider=c,this.beaconService=s,this.pushBackendProvider=r,this.browserService=l,this.accountService=b,this.protocolService=d,this.dataService=h,this.walletConnectService=p,this.txInfos=[],this.protocols=[]}dismiss(){this.router.navigateByUrl("/tabs/portfolio").catch(Object(m.b)(m.a.NAVIGATION))}ionViewWillEnter(){return Object(l.a)(this,void 0,void 0,function*(){yield this.platform.ready(),this.route.snapshot.data.special&&(this.messageDefinitionObjects=this.route.snapshot.data.special.messageDefinitionObjects),this.messageDefinitionObjects.forEach(t=>Object(l.a)(this,void 0,void 0,function*(){const e=yield this.protocolService.getProtocol(t.protocol),o=this.accountService.walletBySerializerAccountIdentifier(t.payload.accountIdentifier,t.protocol),[i,n]=yield this.beaconService.getVaultRequest(),a=i&&n&&n.identifier===e.identifier?n:o&&o.protocol?o.protocol:e;this.txInfos.push([t.payload.transaction,a,i]),this.protocols.push(a)}))})}broadcastTransaction(){return Object(l.a)(this,void 0,void 0,function*(){if(1===this.protocols.length&&this.protocols[0].identifier===d.MainProtocolSymbols.XTZ_SHIELDED)return void(yield this.wrapInTezosOperation(this.protocols[0],this.txInfos[0][0]));const t=yield this.loadingCtrl.create({message:"Broadcasting..."});t.present().catch(Object(m.b)(m.a.NAVIGATION));const e=setTimeout(()=>Object(l.a)(this,void 0,void 0,function*(){t.dismiss().catch(Object(m.b)(m.a.NAVIGATION)),(yield this.toastCtrl.create({duration:3e3,message:"Transaction queued. It might take some time until your TX shows up!",buttons:[{text:"Ok",role:"cancel"}],position:"bottom"})).present().catch(Object(m.b)(m.a.IONIC_TOAST)),this.router.navigateByUrl("/tabs/portfolio").catch(Object(m.b)(m.a.NAVIGATION))}),2e4);this.txInfos.forEach(([o,i,n],a)=>Object(l.a)(this,void 0,void 0,function*(){i.broadcastTransaction(o).then(c=>Object(l.a)(this,void 0,void 0,function*(){if(console.log("transaction hash",c),n)if(n.transaction)this.walletConnectService.approveRequest(n.id,c);else{const t={id:n.id,type:this.beaconService.getResponseByRequestType(n.type),transactionHash:c};this.beaconService.respond(t,n).catch(Object(m.b)(m.a.BEACON))}e&&clearInterval(e);const s={protocol:this.messageDefinitionObjects[a].protocol,accountIdentifier:this.messageDefinitionObjects[a].payload.accountIdentifier,date:(new Date).getTime()};if(this.storageProvider.set(y.a.LAST_TX_BROADCAST,s).catch(Object(m.b)(m.a.STORAGE)),t.dismiss().catch(Object(m.b)(m.a.NAVIGATION)),this.showTransactionSuccessfulAlert(i,c),i.options.network.type===h.NetworkType.MAINNET){const t=(yield i.getTransactionDetailsFromSigned(this.messageDefinitionObjects[a].payload))[0];t.amount=t.amount.toString(),t.fee=t.fee.toString(),t.signedTx=o,t.hash=c,console.log("SIGNED TX",t),this.pushBackendProvider.postPendingTx(t)}})).catch(n=>{e&&clearInterval(e),Object(m.b)(m.a.COINLIB)(n),t.dismiss().catch(Object(m.b)(m.a.NAVIGATION)),n&&n.message&&n.message.startsWith("Failed to check for transaction receipt")?i.getTransactionDetailsFromSigned(this.messageDefinitionObjects[a].payload).then(t=>{t.hash?(this.showTransactionSuccessfulAlert(i,t.hash),t.amount=t.amount.toString(),t.fee=t.fee.toString(),t.signedTx=o,this.pushBackendProvider.postPendingTx(t)):Object(m.b)(m.a.COINLIB)("No transaction hash present in signed ETH transaction")}):this.toastCtrl.create({duration:5e3,message:"Transaction broadcasting failed: "+n,buttons:[{text:"Ok",role:"cancel"}],position:"bottom"}).then(t=>{t.present().catch(Object(m.b)(m.a.NAVIGATION))}).catch(Object(m.b)(m.a.IONIC_TOAST)),this.router.navigateByUrl("/tabs/portfolio").catch(Object(m.b)(m.a.NAVIGATION))})}))})}showTransactionSuccessfulAlert(t,e){return Object(l.a)(this,void 0,void 0,function*(){const o=yield t.getBlockExplorerLinkForTxId(e);this.alertCtrl.create({header:"Transaction broadcasted!",message:"Your transaction has been successfully broadcasted",buttons:[{text:"Open Blockexplorer",handler:()=>{this.browserService.openUrl(o),this.router.navigateByUrl("/tabs/portfolio").catch(Object(m.b)(m.a.NAVIGATION))}},{text:"Ok",handler:()=>{this.router.navigateByUrl("/tabs/portfolio").catch(Object(m.b)(m.a.NAVIGATION))}}]}).then(t=>{t.present().catch(Object(m.b)(m.a.NAVIGATION))}).catch(Object(m.b)(m.a.IONIC_ALERT))})}wrapInTezosOperation(t,e){return Object(l.a)(this,void 0,void 0,function*(){const o=yield this.selectTezosTzAccount(t),i=yield t.wrapSaplingTransactions(o.publicKey,e,new u.a(o.protocol.feeDefaults.medium).shiftedBy(o.protocol.feeDecimals).toString(),!0),n=yield t.getTransactionDetails({publicKey:o.publicKey,transaction:i},{knownViewingKeys:this.accountService.getKnownViewingKeys()});this.dataService.setData(T.b.INTERACTION,{wallet:o,airGapTxs:n,data:i,type:d.IACMessageType.TransactionSignRequest}),this.router.navigateByUrl("/interaction-selection/"+T.b.INTERACTION).catch(Object(m.b)(m.a.NAVIGATION))})}selectTezosTzAccount(t){return Object(l.a)(this,void 0,void 0,function*(){return new Promise(e=>{const o=this.accountService.getWalletList(),[i,n]=Object(b.K)(o,t=>t.protocol.identifier===d.MainProtocolSymbols.XTZ);this.dataService.setData(T.b.ACCOUNTS,{actionType:"broadcast",targetIdentifier:t.identifier,compatibleWallets:i,incompatibleWallets:n,callback:e}),this.router.navigateByUrl(`/select-wallet/${T.b.ACCOUNTS}`).catch(Object(m.b)(m.a.NAVIGATION))})})}}return t.\u0275fac=function(e){return new(e||t)(I.Nb(c.lb),I.Nb(c.wb),I.Nb(a.g),I.Nb(a.a),I.Nb(c.a),I.Nb(c.qb),I.Nb(y.b),I.Nb(S.a),I.Nb(O.a),I.Nb(f.a),I.Nb(g.a),I.Nb(b.x),I.Nb(T.a),I.Nb(v.a))},t.\u0275cmp=I.Hb({type:t,selectors:[["page-transaction-confirm"]],decls:23,vars:11,consts:[[1,"ion-no-border"],["fixed","true",1,"ion-no-padding"],["slot","start"],["defaultHref","/"],[1,"ion-padding"],[3,"signedTxs","protocols"],["vertical","bottom","slot","fixed"],["size","default","expand","full","color","secondary","shape","round",3,"click"],["slot","start","name","close"],["size","default","expand","full","color","primary","shape","round",3,"click"],["slot","start","name","checkmark"]],template:function(t,e){1&t&&(I.Sb(0,"ion-header",0),I.Sb(1,"ion-grid",1),I.Sb(2,"ion-toolbar"),I.Sb(3,"ion-buttons",2),I.Ob(4,"ion-back-button",3),I.Rb(),I.Sb(5,"ion-title"),I.yc(6),I.dc(7,"translate"),I.Rb(),I.Rb(),I.Rb(),I.Rb(),I.Sb(8,"ion-content",4),I.Sb(9,"ion-grid",1),I.Ob(10,"signed-transaction",5),I.Rb(),I.Sb(11,"ion-fab",6),I.Sb(12,"ion-row"),I.Sb(13,"ion-col"),I.Sb(14,"ion-button",7),I.ac("click",function(){return e.dismiss()}),I.Ob(15,"ion-icon",8),I.yc(16),I.dc(17,"translate"),I.Rb(),I.Rb(),I.Sb(18,"ion-col"),I.Sb(19,"ion-button",9),I.ac("click",function(){return e.broadcastTransaction()}),I.Ob(20,"ion-icon",10),I.yc(21),I.dc(22,"translate"),I.Rb(),I.Rb(),I.Rb(),I.Rb(),I.Rb()),2&t&&(I.Cb(6),I.zc(I.ec(7,5,"transaction-confirm.title")),I.Cb(4),I.ic("signedTxs",e.messageDefinitionObjects)("protocols",e.protocols),I.Cb(6),I.Ac(" ",I.ec(17,7,"transaction-confirm.decline_label")," "),I.Cb(5),I.Ac(" ",I.ec(22,9,"transaction-confirm.confirm_label")," "))},directives:[c.v,c.u,c.ib,c.j,c.f,c.g,c.gb,c.q,R,c.r,c.Q,c.p,c.i,c.w],pipes:[s.c],styles:["ion-fab[_ngcontent-%COMP%]{width:100%}"]}),t})(),P=(()=>{class t{}return t.\u0275fac=function(e){return new(e||t)},t.\u0275mod=I.Lb({type:t}),t.\u0275inj=I.Kb({imports:[[c.jb,i.c,n.e,s.b,r.a,a.j.forChild([{path:"",component:k}])]]}),t})()}}]);